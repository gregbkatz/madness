<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, viewport-fit=cover, height=device-height">
    <title>March Madness Bracket</title>
    <!-- Mobile Scrolling Fix -->
    <script>
        // iOS-specific scroll fix
        document.addEventListener('DOMContentLoaded', function () {
            // Fix iOS Safari viewport issues
            let viewportHeight = window.innerHeight;
            document.documentElement.style.setProperty('--vh', `${viewportHeight * 0.01}px`);

            // Disable pull-to-refresh
            document.body.addEventListener('touchmove', function (e) {
                if (e.target.closest('.bracket-container')) {
                    e.stopPropagation();
                }
            }, { passive: false });

            // Ensure all content is visible in viewport
            window.addEventListener('scroll', function () {
                // If we're at the bottom, make sure we stay there
                if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 10) {
                    window.scrollTo(0, document.body.offsetHeight);
                }
            });
        });
    </script>
    <!-- React and ReactDOM - Local Files -->
    <script src="{{ url_for('static', filename='js/react.development.js') }}"></script>
    <script src="{{ url_for('static', filename='js/react-dom.development.js') }}"></script>
    <!-- Babel for JSX transpilation - Local File -->
    <script src="{{ url_for('static', filename='js/babel.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>

<body>
    <div id="status-banner" class="status-banner"></div>
    <header id="app-header" class="app-header">
        <h1>March Madness Bracket</h1>
        <div class="header-info">
            {% if username %}
            <div class="user-info">User: {{ username }}</div>
            {% if not session.read_only %}
            <div id="save-status" class="save-status">üìã No changes yet</div>
            <div id="completion-status" class="completion-status">‚ö†Ô∏è 63 picks remaining</div>
            {% endif %}
            <div class="change-user">
                {% if not session.read_only %}
                <a href="/logout" class="change-user-button">Change User</a>
                {% endif %}

                {% if session.read_only %}
                <a href="/users-list" class="change-user-button" style="margin-left: 10px;">Users List</a>
                <a href="/scores" class="change-user-button" style="margin-left: 10px;">Live Scores</a>
                {% endif %}
            </div>
            {% endif %}
        </div>
    </header>
    <div id="root"></div>

    {% if truth_file_names %}
    <div class="truth-slider-container" style="margin-top: 20px;">
        <div class="slider-header">
            <span>Tournament Timeline</span>
            <span id="current-truth-file">{{ current_truth_file }}</span>
        </div>
        <div class="slider-controls">
            <button id="prev-truth-file" class="timeline-btn">‚Üê</button>
            <div class="slider-with-label">
                <input type="range" id="truth-file-slider" min="0" max="{{ truth_file_names|length - 1 }}"
                    value="{{ truth_file_names|length - 1 - selected_index }}" class="slider">
            </div>
            <button id="next-truth-file" class="timeline-btn">‚Üí</button>
        </div>
    </div>
    {% endif %}

    <script type="text/babel" src="{{ url_for('static', filename='js/bracket.js') }}"></script>
    <!-- Force bottom content to be scrollable -->
    <div style="height: 100px;"></div>
    <script>
        // Extra iOS mobile scroll fix
        document.addEventListener('DOMContentLoaded', function () {
            // Add padding to ensure scrollability on mobile
            function addPadding() {
                let bodyHeight = document.body.offsetHeight;
                let windowHeight = window.innerHeight;

                // Force scroll by adding padding if needed
                if (bodyHeight <= windowHeight) {
                    document.body.style.paddingBottom = '200px';
                }
            }

            // Apply immediately and when orientation changes
            addPadding();
            window.addEventListener('resize', addPadding);
            window.addEventListener('orientationchange', addPadding);

            // Force scroll to stay at bottom when user reaches bottom
            document.addEventListener('scroll', function () {
                if ((window.innerHeight + window.pageYOffset) >= document.body.offsetHeight - 10) {
                    // Force scroll to bottom
                    setTimeout(function () {
                        window.scrollTo(0, document.body.offsetHeight);
                    }, 0);
                }
            });

            // Timeline slider functionality for bracket page
            const truthSlider = document.getElementById('truth-file-slider');
            const currentTruthFile = document.getElementById('current-truth-file');
            const prevButton = document.getElementById('prev-truth-file');
            const nextButton = document.getElementById('next-truth-file');

            if (truthSlider && currentTruthFile) {
                // Get the max slider value
                const maxSliderValue = parseInt(truthSlider.max);

                // Update button states
                function updateButtonStates(sliderValue) {
                    prevButton.disabled = sliderValue >= maxSliderValue;
                    nextButton.disabled = sliderValue <= 0;
                }

                // Initialize button states
                updateButtonStates(parseInt(truthSlider.value));

                // Slider to index conversion
                function sliderValueToIndex(value) {
                    return maxSliderValue - value;
                }

                // Add event listeners
                let sliderTimer;
                truthSlider.addEventListener('input', function () {
                    // Update displayed filename
                    const fileNames = JSON.parse('{{ truth_file_names|tojson|safe }}');
                    const sliderValue = parseInt(this.value);
                    const index = sliderValueToIndex(sliderValue);

                    if (fileNames && index >= 0 && index < fileNames.length) {
                        currentTruthFile.textContent = fileNames[index];
                    }

                    // Update button states
                    updateButtonStates(sliderValue);

                    // Clear existing timer
                    clearTimeout(sliderTimer);

                    // Set new timer to update bracket
                    sliderTimer = setTimeout(function () {
                        // Redirect to the same page with the selected truth index
                        window.location.href = `/?username={{ username }}&truth_index=${index}`;
                    }, 300);
                });

                // Add event listeners for prev/next buttons
                prevButton.addEventListener('click', function () {
                    const currentValue = parseInt(truthSlider.value);
                    if (currentValue > 0) {
                        truthSlider.value = currentValue - 1;
                        truthSlider.dispatchEvent(new Event('input'));
                    }
                });

                nextButton.addEventListener('click', function () {
                    const currentValue = parseInt(truthSlider.value);
                    if (currentValue < maxSliderValue) {
                        truthSlider.value = currentValue + 1;
                        truthSlider.dispatchEvent(new Event('input'));
                    }
                });
            }
        });
    </script>
</body>

</html>